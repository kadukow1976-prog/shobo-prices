<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–£–∑–Ω–∞—Ç—å —Å—Ç–æ–∏–º–æ—Å—Ç—å —Ä–µ–º–æ–Ω—Ç–∞ ‚Äî –£–≥—Ä–∞–†–µ–º–ö–æ–º–ø</title>
  <style>
    :root{
      --bg:#f7f7f8;--card:#fff;--text:#111;--muted:#667085;
      --accent:#16a34a;--accent-press:#0f8a3d;--border:#e5e7eb;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", sans-serif}
    .container{max-width:900px;margin:0 auto;padding:16px}
    .top{
      display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap;margin:8px 0 16px
    }
    h1{font-size:26px;margin:0}
    .call{
      display:inline-flex;align-items:center;gap:10px;
      background:var(--accent);color:#fff;border:0;border-radius:12px;
      padding:12px 18px;font-weight:600;text-decoration:none;
      box-shadow:0 6px 14px rgba(22,163,74,.25)
    }
    .call:active{background:var(--accent-press)}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px}
    .searchWrap{position:relative;margin-bottom:10px}
    .search{width:100%;padding:14px 16px;border:1px solid var(--border);border-radius:12px;font-size:16px}
    .hint{color:var(--muted);font-size:13px;margin:4px 2px 10px}
    .meta{display:flex;justify-content:space-between;align-items:center;color:var(--muted);font-size:13px;margin:4px 2px 10px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:12px 10px;border-top:1px solid var(--border)}
    th{font-weight:700;text-align:left;background:#fafafa}
    td.price{white-space:nowrap;text-align:right;font-variant-numeric: tabular-nums}
    .empty{padding:20px;text-align:center;color:var(--muted)}
    .error{margin-top:12px;padding:12px;border:1px solid #fecaca;background:#fef2f2;border-radius:12px;color:#b91c1c}
    /* –ø–ª–∞–≤–∞—é—â–∞—è –∫–Ω–æ–ø–∫–∞ –Ω–∞ –º–æ–±–∏–ª–∫–µ */
    .fab{
      position:fixed;right:16px;bottom:16px;z-index:3;
      display:none
    }
    @media (max-width:680px){ .fab{display:block} }
  </style>
</head>
<body>
  <div class="container">
    <div class="top">
      <h1>–£–∑–Ω–∞—Ç—å —Å—Ç–æ–∏–º–æ—Å—Ç—å —Ä–µ–º–æ–Ω—Ç–∞</h1>
      <!-- ‚úÖ –ø–æ–º–µ–Ω—è–π –Ω–æ–º–µ—Ä –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ -->
      <a class="call" href="tel:+79107116072" aria-label="–ü–æ–∑–≤–æ–Ω–∏—Ç—å">
        üìû –ü–æ–∑–≤–æ–Ω–∏—Ç—å
      </a>
    </div>

    <div class="card">
      <div class="searchWrap">
        <input id="searchInput" class="search"
          placeholder="–û–ø–∏—à–∏—Ç–µ –ø—Ä–æ–±–ª–µ–º—É: ¬´—Ä–∞–∑–±–∏—Ç —ç–∫—Ä–∞–Ω¬ª, ¬´–Ω–µ –∑–∞—Ä—è–∂–∞–µ—Ç—Å—è¬ª, ¬´—É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Windows¬ª‚Ä¶" />
      </div>
      <div class="meta">
        <div id="found">–ó–∞–≥—Ä—É–∂–∞–µ–º —Ü–µ–Ω—ã‚Ä¶</div>
        <div id="updated"></div>
      </div>

      <div class="tableWrap">
        <table aria-label="–ü—Ä–∞–π—Å –Ω–∞ —É—Å–ª—É–≥–∏">
          <thead>
            <tr><th>–ü—Ä–æ–±–ª–µ–º–∞</th><th class="price">–¶–µ–Ω–∞</th></tr>
          </thead>
          <tbody id="priceTable">
            <tr><td colspan="2" class="empty">–ó–∞–≥—Ä—É–∂–∞–µ–º‚Ä¶</td></tr>
          </tbody>
        </table>
      </div>

      <div id="errorBox" class="error" style="display:none"></div>
    </div>
  </div>

  <!-- –ø–ª–∞–≤–∞—é—â–∞—è –∫–Ω–æ–ø–∫–∞ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö -->
  <a class="call fab" href="tel:+79107116072">üìû –ü–æ–∑–≤–æ–Ω–∏—Ç—å</a>

  <script>
    // ‚öôÔ∏è –°–°–´–õ–ö–ê –ù–ê –û–ü–£–ë–õ–ò–ö–û–í–ê–ù–ù–´–ô CSV (Google Sheets ‚Üí –§–∞–π–ª ‚Üí –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å ‚Üí –°—Å—ã–ª–∫–∞ ‚Üí CSV)
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQBjrIZhKXqFtutZJChMn-zej9fqm679V6aMTW6pXqF19PivgbeYIO0mL_UiNx3WryYzyFxOcDwpPYh/pub?gid=0&single=true&output=csv";

    const $ = sel => document.querySelector(sel);
    const table = $("#priceTable");
    const found = $("#found");
    const updated = $("#updated");
    const errorBox = $("#errorBox");
    const input = $("#searchInput");

    let allRows = [];

    // –ù–µ–±–æ–ª—å—à–æ–π –¥–µ–±–∞—É–Ω—Å, —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É –Ω–∞ –∫–∞–∂–¥—ã–π —Å–∏–º–≤–æ–ª
    const debounce = (fn, ms=200) => {
      let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), ms); };
    };

    // –ê–∫–∫—É—Ä–∞—Ç–Ω—ã–π CSV-–ø–∞—Ä—Å–µ—Ä (–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∫–∞–≤—ã—á–∫–∏ –∏ –∑–∞–ø—è—Ç—ã–µ –≤–Ω—É—Ç—Ä–∏ —è—á–µ–µ–∫)
    function parseCSV(text) {
      const rows = []; let row = [], cell = "", quoted = false;
      for (let i=0;i<text.length;i++) {
        const c = text[i], n = text[i+1];
        if (quoted) {
          if (c === '"' && n === '"') { cell += '"'; i++; }
          else if (c === '"') { quoted = false; }
          else { cell += c; }
        } else {
          if (c === '"') quoted = true;
          else if (c === ',') { row.push(cell); cell = ""; }
          else if (c === '\n' || c === '\r') {
            if (c === '\r' && n === '\n') i++;
            row.push(cell); rows.push(row); row = []; cell = "";
          } else { cell += c; }
        }
      }
      if (cell.length || row.length) { row.push(cell); rows.push(row); }
      return rows;
    }

    function formatRub(n) {
      // –¥–æ–ø—É—Å–∫–∞–µ–º "1000" –∏–ª–∏ "1 000" –≤ CSV
      const num = Number(String(n).replace(/\s/g,'').replace(',', '.'));
      if (isFinite(num)) {
        return num.toLocaleString('ru-RU') + ' ‚ÇΩ';
      }
      return n || '';
    }

    function render(data) {
      table.innerHTML = "";
      if (!data.length) {
        table.innerHTML = `<tr><td colspan="2" class="empty">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</td></tr>`;
      } else {
        const frag = document.createDocumentFragment();
        for (const [problem, price] of data) {
          if (!problem) continue;
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${problem}</td><td class="price">${formatRub(price)}</td>`;
          frag.appendChild(tr);
        }
        table.appendChild(frag);
      }
      found.textContent = `–ù–∞–π–¥–µ–Ω–æ: ${data.length} –∏–∑ ${allRows.length}`;
    }

    const doFilter = debounce(() => {
      const q = input.value.trim().toLowerCase();
      if (!q) { render(allRows); return; }
      const filtered = allRows.filter(([problem]) =>
        String(problem).toLowerCase().includes(q)
      );
      render(filtered);
    }, 150);

    input.addEventListener("input", doFilter);

    async function load() {
      try {
        errorBox.style.display = "none";
        found.textContent = "–ó–∞–≥—Ä—É–∂–∞–µ–º —Ü–µ–Ω—ã‚Ä¶";
        const res = await fetch(CSV_URL + "&_=" + Date.now(), {cache:"no-store"});
        if (!res.ok) throw new Error("HTTP " + res.status);
        const text = await res.text();
        const rows = parseCSV(text);

        // –û–∂–∏–¥–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏: –ü—Ä–æ–±–ª–µ–º–∞, –¶–µ–Ω–∞
        const [h1, h2] = rows[0] || [];
        const goodHeader =
          (String(h1).trim().toLowerCase() === "–ø—Ä–æ–±–ª–µ–º–∞" &&
           String(h2).trim().toLowerCase() === "—Ü–µ–Ω–∞");

        if (!goodHeader)
          throw new Error("–í –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–æ–∫–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∑–∞–≥–æ–ª–æ–≤–∫–∏: ¬´–ü—Ä–æ–±–ª–µ–º–∞, –¶–µ–Ω–∞¬ª");

        // –¥–∞–Ω–Ω—ã–µ –±–µ–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞ + —Ñ–∏–ª—å—Ç—Ä –ø—É—Å—Ç—ã—Ö —Å—Ç—Ä–æ–∫
        allRows = rows.slice(1).filter(r => r[0] && (r[1] !== undefined));
        render(allRows);

        // –ø–æ–∫–∞–∂–µ–º, –∫–æ–≥–¥–∞ –æ–±–Ω–æ–≤–∏–ª–∏
        const dt = new Date();
        updated.textContent = `–û–±–Ω–æ–≤–ª–µ–Ω–æ: ${dt.toLocaleDateString('ru-RU')} ${dt.toLocaleTimeString('ru-RU').slice(0,5)}`;
      } catch (e) {
        console.error(e);
        errorBox.textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∞–π—Å–∞: " + e.message;
        errorBox.style.display = "block";
        table.innerHTML = `<tr><td colspan="2" class="empty">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</td></tr>`;
        found.textContent = "–ù–∞–π–¥–µ–Ω–æ: 0";
      }
    }

    load();
  </script>
</body>
</html>
