<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>–ü—Ä–∞–π—Å –£–≥—Ä–∞–†–µ–º–ö–æ–º–ø ‚Äî –ø–æ–∏—Å–∫ –∏ —Ñ–∏–ª—å—Ç—Ä—ã</title>
<style>
  :root{
    --bg:#f6f7f9;--card:#fff;--text:#111;--muted:#6b7280;--line:#e5e7eb;
    --accent:#0ea5e9;--accent2:#0369a1;--ok:#16a34a;--warn:#ef4444
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{max-width:1100px;margin:0 auto;padding:18px}
  header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:12px}
  h1{margin:0;font-size:clamp(22px,4.5vw,38px)}
  .call{display:inline-flex;gap:10px;align-items:center;padding:10px 14px;border-radius:10px;background:var(--ok);color:#fff;text-decoration:none;font-weight:700}
  .panel{display:grid;gap:10px;grid-template-columns:1.2fr 1fr 1fr .8fr .8fr auto auto;background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px}
  .panel input,.panel select,.panel button{height:42px;padding:10px;border:1px solid var(--line);border-radius:10px;background:#fff}
  .btn{background:var(--accent);color:#fff;border:none;font-weight:700;cursor:pointer}
  .btn:hover{background:var(--accent2)}
  .ghost{background:#fff;border:1px solid var(--line)}
  .stats{grid-column:1/-1;color:var(--muted);font-size:13px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:12px;margin-top:12px;overflow:auto}
  table{width:100%;border-collapse:collapse}
  th,td{padding:12px 12px;border-bottom:1px solid var(--line);vertical-align:top}
  th{background:#fafafa;text-align:left;position:sticky;top:0}
  th.sortable{user-select:none;cursor:pointer}
  th.sortable::after{content:" ‚áÖ";opacity:.4}
  th.sortable[data-dir="1"]::after{content:" ‚Üë";opacity:1}
  th.sortable[data-dir="-1"]::after{content:" ‚Üì";opacity:1}
  td.price{text-align:right;font-variant-numeric:tabular-nums;font-weight:700;white-space:nowrap}
  td.note{color:var(--muted);font-size:12px}
  tr:hover{background:#fcfcfc}
  .err{margin-top:12px;padding:12px;border:1px solid #fecaca;background:#fff1f2;color:#991b1b;border-radius:10px}
  .wa{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:8px;border:1px solid var(--line);text-decoration:none}
  .wa:hover{border-color:var(--accent2)}
  @media (max-width:980px){.panel{grid-template-columns:1fr 1fr 1fr;grid-auto-rows:auto}}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>–ü—Ä–∞–π—Å –£–≥—Ä–∞–†–µ–º–ö–æ–º–ø</h1>
    <a class="call" href="tel:+79107116072">üìû –ü–æ–∑–≤–æ–Ω–∏—Ç—å</a>
  </header>

  <!-- –ü–∞–Ω–µ–ª—å —Ñ–∏–ª—å—Ç—Ä–æ–≤ -->
  <div class="panel">
    <input id="q" placeholder="–ü–æ–∏—Å–∫ (–±—Ä–µ–Ω–¥, –∫–∞—Ç–µ–≥–æ—Ä–∏—è, –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ, –ø—Ä–∏–º–µ—á–∞–Ω–∏–µ, —Ü–µ–Ω–∞)">
    <select id="brand"><option value="">–í—Å–µ –±—Ä–µ–Ω–¥—ã</option></select>
    <select id="cat"><option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option></select>
    <input id="minp" type="number" inputmode="numeric" placeholder="–æ—Ç ‚ÇΩ">
    <input id="maxp" type="number" inputmode="numeric" placeholder="–¥–æ ‚ÇΩ">
    <button id="apply" class="btn">–§–∏–ª—å—Ç—Ä</button>
    <button id="reset" class="ghost">–°–±—Ä–æ—Å</button>
    <div class="stats" id="stats"></div>
  </div>

  <!-- –¢–∞–±–ª–∏—Ü–∞ -->
  <div class="card">
    <table id="tbl">
      <thead>
        <tr>
          <th class="sortable" data-k="brand">–ë—Ä–µ–Ω–¥</th>
          <th class="sortable" data-k="cat">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
          <th class="sortable" data-k="name">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th>
          <th class="sortable price" data-k="price">–¶–µ–Ω–∞, –æ—Ç</th>
          <th>–î–µ–π—Å—Ç–≤–∏–µ</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="error" class="err" style="display:none"></div>
</div>

<script>
/* === –ù–ê–°–¢–†–û–ô–ö–ò === */
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQWvp61TLX1tVmw7o34TY2Qjde4r-343ELRv14YnbrkSC0z7MAQse2lFVzWk2HcePyCfRfEIQ4jVh09/pub?gid=0&single=true&output=csv";
const WA_PHONE = "79107116072"; // –¥–ª—è –∫–Ω–æ–ø–∫–∏ WhatsApp

/* === –£–¢–ò–õ–ò–¢–´ === */
const $ = (s, r=document)=>r.querySelector(s);
const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));
const esc = s => String(s??'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
const toNum = v => {
  if (typeof v==='number') return v;
  const s=String(v||'').replace(/[^\d.,-]/g,'').replace(/\.(?=.*\.)/g,'').replace(',','.');
  const n=Number(s); return Number.isFinite(n) ? n : NaN;
};
const waLink = txt => `https://wa.me/${WA_PHONE}?text=${encodeURIComponent('–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –ò–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç: ' + txt)}`;

/* === CSV-–ø–∞—Ä—Å–µ—Ä (–∫–∞–≤—ã—á–∫–∏, –∑–∞–ø—è—Ç—ã–µ –≤–Ω—É—Ç—Ä–∏) === */
function parseCSV(text){
  const out=[]; let row=[], cur="", q=false;
  for(let i=0;i<text.length;i++){
    const c=text[i], n=text[i+1];
    if(q){ if(c=='"'&&n=='"'){cur+='"';i++;} else if(c=='"'){q=false;} else cur+=c; }
    else{ if(c=='"'){q=true;} else if(c==','){row.push(cur);cur="";}
      else if(c=='\n'){row.push(cur);out.push(row);row=[];cur="";}
      else if(c!='\r'){cur+=c;}
    }
  }
  row.push(cur); out.push(row);
  if(out.length && out[out.length-1].every(v=>v==="")) out.pop();
  return out;
}

/* === –°–æ—Å—Ç–æ—è–Ω–∏–µ === */
const st={rows:[],view:[],sort:{k:'price',dir:1},q:'',brand:'',cat:'',min:null,max:null};

/* === –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö === */
async function loadData(){
  try{
    const r = await fetch(CSV_URL,{cache:'no-store'});
    if(!r.ok) throw new Error('HTTP '+r.status);
    const txt = await r.text();
    const rows = parseCSV(txt);
    if(!rows.length) throw new Error('CSV –ø—É—Å—Ç');

    // –æ–∂–∏–¥–∞–µ–º—ã–µ —Ä—É—Å—Å–∫–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏
    const hdr = rows[0].map(s=>String(s).trim().toLowerCase());
    const m = {
      brand: hdr.indexOf('–±—Ä–µ–Ω–¥'),
      cat:   hdr.indexOf('–∫–∞—Ç–µ–≥–æ—Ä–∏—è'),
      name:  hdr.indexOf('–Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ'),
      price: hdr.indexOf('—Ü–µ–Ω–∞'),
      note:  hdr.indexOf('–ø—Ä–∏–º–µ—á–∞–Ω–∏–µ')
    };
    if([m.brand,m.cat,m.name,m.price].some(i=>i<0)){
      throw new Error('–í CSV –Ω—É–∂–Ω—ã –∑–∞–≥–æ–ª–æ–≤–∫–∏: –ë—Ä–µ–Ω–¥, –ö–∞—Ç–µ–≥–æ—Ä–∏—è, –ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ, –¶–µ–Ω–∞ (+ –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ –ø–æ –∂–µ–ª–∞–Ω–∏—é)');
    }

    st.rows = rows.slice(1)
      .filter(r=>r.some(x=>String(x).trim()!==''))
      .map(r=>({
        brand: String(r[m.brand]||'').trim(),
        cat:   String(r[m.cat]||'').trim(),
        name:  String(r[m.name]||'').trim(),
        price: toNum(r[m.price]),
        note:  String(r[m.note]||'').trim()
      }))
      .filter(x=>x.name);

    buildFilters(st.rows);
    applyFilters();
  }catch(e){
    $('#error').style.display='';
    $('#error').textContent='–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∞–π—Å–∞: '+e.message;
  }
}

/* === –§–∏–ª—å—Ç—Ä—ã (–∞–≤—Ç–æ—Å–ø–∏—Å–∫–∏ –∏–∑ –¥–∞–Ω–Ω—ã—Ö) === */
function buildFilters(rows){
  const brands=[...new Set(rows.map(x=>x.brand).filter(Boolean))].sort((a,b)=>a.localeCompare(b,'ru'));
  const cats  =[...new Set(rows.map(x=>x.cat).filter(Boolean))].sort((a,b)=>a.localeCompare(b,'ru'));
  const brandSel = $('#brand'), catSel = $('#cat');
  for(const v of brands){ const o=document.createElement('option'); o.textContent=v; brandSel.appendChild(o); }
  for(const v of cats){ const o=document.createElement('option'); o.textContent=v; catSel.appendChild(o); }
}

/* === –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤ –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ === */
function applyFilters(){
  const q = st.q.trim().toLowerCase();
  let v = st.rows.filter(r=>{
    if(st.brand && r.brand!==st.brand) return false;
    if(st.cat && r.cat!==st.cat) return false;
    if(st.min!=null && Number.isFinite(r.price) && r.price<st.min) return false;
    if(st.max!=null && Number.isFinite(r.price) && r.price>st.max) return false;
    if(q){
      const hay=(r.brand+' '+r.cat+' '+r.name+' '+(r.note||'')+' '+(Number.isFinite(r.price)?r.price:'' )).toLowerCase();
      if(!hay.includes(q)) return false;
    }
    return true;
  });

  const {k,dir}=st.sort;
  v.sort((a,b)=>{
    if(k==='price'){
      const av=Number.isFinite(a.price)?a.price:Infinity;
      const bv=Number.isFinite(b.price)?b.price:Infinity;
      return dir*(av-bv);
    }
    return dir*String(a[k]).localeCompare(String(b[k]),'ru');
  });

  st.view=v;
  render();
}

/* === –†–µ–Ω–¥–µ—Ä —Ç–∞–±–ª–∏—Ü—ã === */
function render(){
  const tb = $('#tbl tbody');
  const fmt = n => Number.isFinite(n) ? n.toLocaleString('ru-RU') : '‚Äî';
  tb.innerHTML = st.view.length ? st.view.map(r=>`
    <tr>
      <td>${esc(r.brand)}</td>
      <td>${esc(r.cat)}</td>
      <td>${esc(r.name)}${r.note?`<div class="note">${esc(r.note)}</div>`:''}</td>
      <td class="price">${fmt(r.price)}</td>
      <td><a class="wa" target="_blank" rel="noopener" href="${waLink(`${r.brand} ${r.name} ‚Äî ${fmt(r.price)} ‚ÇΩ`)}">–ó–∞–∫–∞–∑–∞—Ç—å</a></td>
    </tr>
  `).join('') : `<tr><td colspan="5" style="text-align:center;color:#666;padding:18px">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</td></tr>`;

  $('#stats').textContent = `–ù–∞–π–¥–µ–Ω–æ: ${st.view.length} –∏–∑ ${st.rows.length}`;
  // –æ–±–Ω–æ–≤–∏—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
  $$('#tbl thead th.sortable').forEach(th=>{
    th.dataset.dir = (th.dataset.k===st.sort.k) ? String(st.sort.dir) : '';
  });
}

/* === –°–æ–±—ã—Ç–∏—è UI === */
function bindUI(){
  $('#apply').onclick = ()=>{
    st.q=$('#q').value; st.brand=$('#brand').value; st.cat=$('#cat').value;
    st.min=$('#minp').value?+$('#minp').value:null; st.max=$('#maxp').value?+$('#maxp').value:null;
    applyFilters();
  };
  $('#reset').onclick = ()=>{
    $('#q').value=''; $('#brand').value=''; $('#cat').value=''; $('#minp').value=''; $('#maxp').value='';
    st.q=''; st.brand=''; st.cat=''; st.min=null; st.max=null; st.sort={k:'price',dir:1};
    applyFilters();
  };
  $('#q').addEventListener('input', ()=>{ st.q=$('#q').value; applyFilters(); });
  $$('#tbl thead th.sortable').forEach(th=>{
    th.onclick = ()=>{ const k=th.dataset.k; st.sort = (st.sort.k===k)? {k,dir:-st.sort.dir} : {k,dir:1}; applyFilters(); };
  });
}

/* === –°—Ç–∞—Ä—Ç === */
bindUI();
loadData();
</script>
</body>
</html>
